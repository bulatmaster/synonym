# –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è 
# –ø—Ä–æ–≥—Ä–∞–º–º–∞ –≤—ã–¥–∞–µ—Ç —Ä–∞–Ω–¥–æ–º–Ω—ã–µ —Ñ—Ä–∞–∑—ã –∏–∑ –∑–∞–¥–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤-—Å–∏–Ω–æ–Ω–∏–º–æ–≤ –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º —à–∞–±–ª–æ–Ω–∞–º (—Ñ–æ—Ä–º—É–ª–∞–º) –∏ —Å—Ç–∞–≤–∏—Ç –∏—Ö –≤ –∑–∞–¥–∞–Ω–Ω—ã–µ –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—ã –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º –≤ –∫–∞–∂–¥–æ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏.
# –Ω—É–∂–Ω–∞ CSV —Ç–∞–±–ª–∏—Ü–∞
# –ø–µ—Ä–µ–¥–∞—Ç—å –ø—É—Ç—å –∫ –Ω–µ–π –≤ –∫–æ–¥–µ –≤ main() –≤ inputFileName 
# –≤ –æ–±—â–µ–º –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º–µ: 1) —Ñ–æ—Ä–º—É–ª—ã 2) —Å–ª–æ–≤–∞ 3) –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–¥–Ω–∏—Ö —Å–ø–∏—Å–∫–æ–≤ —Å–ª–æ–≤ –æ—Ç –¥—Ä—É–≥–∏—Ö 4) —ç—Ñ—Ñ–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ–∫–∞–∑—ã–≤–∞—é—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–ª–æ–≤–∞
# –ø—Ä–∏–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã: https://docs.google.com/spreadsheets/d/1Q0W7kGKGBZzQFkRkcjqrDsUTrhMKQF6a8_a8tDX_vdw/edit?usp=sharing
#
# —Å–∏–Ω—Ç–∞–∫—Å–∏—Å —Ç–∞–±–ª–∏—Ü—ã:
# –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ - –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ (–ø—Ä–∏–º–µ—Ä: A, B, C. –ò–ª–∏: A0, A1, B0, B1). –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –≤—Ö–æ–¥–∏—Ç—å –¥—Ä—É–≥ –≤ –¥—Ä—É–≥–∞. –ü–ª–æ—Ö–æ–π –ø—Ä–∏–º–µ—Ä: A, A1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ: A0, A1
# –ø–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü - —Ñ–æ—Ä–º—É–ª—ã. –ó–∞–≥–æ–ª–æ–≤–æ–∫ 1 —Å—Ç–æ–ª–±—Ü–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –ª—é–±—ã–º
# –ø—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º—É–ª—ã: A + B + C - —Å–∫–ª–µ–∏–≤–∞–µ—Ç —Ä–∞–Ω–¥–æ–º–Ω—ã–µ —Å–ª–æ–≤–∞ –∏–∑ —Å–ø–∏—Å–∫–æ–≤ A, B, C 
# —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å—Ç–æ–±—Ü–æ–≤, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–∫–ª–æ–Ω—è—Ç—å —Å–ª–æ–≤–∞ —ç—Ç–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥—Ä—É–≥–∏—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤: A:B C . –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞: —Å—Ç–æ–ª–±–µ—Ü –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è A, —Å–ª–æ–≤–∞ –≤ –Ω–µ–º –±–µ—Ä—É—Ç —Å–ª–æ–≤–æ—Ñ–æ—Ä–º—É –∏–∑ —Å—Ç–æ–ª–±—Ü–æ–≤ B –∏ C
# –°—Ç–æ–ª–±–µ—Ü –º–æ–∂–µ—Ç —Å—Å—ã–ª–∞—Ç—å—Å—è —Å–∞–º –Ω–∞ —Å–µ–±—è: A:A 
#
# –ï—Å–ª–∏ —Å–ª–æ–≤–∞ –æ–∫–∞–∑—ã–≤–∞—é—Ç –≤–ª–∏—è–Ω–∏–µ, —Å—Ç–∞–≤–∏—Ç—å –≤ —Å–æ—Å–µ–¥–Ω—é—é —Å–ø—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫—É –∏—Ö —ç—Ñ—Ñ–µ–∫—Ç—ã. –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–æ–ª–±—Ü–∞ —Å —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç—ã–º!
# –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —è—á–µ–π–∫—É –ø—Ä–∏ —Å–∫–ª–æ–Ω–µ–Ω–∏–∏: –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å–∏–º–≤–æ–ª $ –≤ —è—á–µ–π–∫–µ
# %—Å–ª–æ–≤–æ% –≤—ã–¥–µ–ª–∏—Ç—å —Å–ª–æ–≤–æ –¥–ª—è —Å–∫–ª–æ–Ω–µ–Ω–∏—è, –º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ. –ê–∫—Ç—É–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –≤ —è—á–µ–π–∫—É –∑–∞—Å–æ–≤—ã–≤–∞–µ—Ç–µ —Å–ª–æ–≤–æ—Å–æ—á–µ—Ç–∞–Ω–∏–µ. –ù–∞–ø—Ä–∏–º–µ—Ä: %–∫—Ä–∞—Å–∏–≤—ã–π% %—Å–ª–æ–Ω%

import sys
import random
import re

import pymorphy2
from pandas import *



def main():
    inputFileName = 'files/' + input('–ù–∞–∑–≤–∞–Ω–∏–µ csv —Ñ–∞–π–ª–∞ (–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è): ') + '.csv'
    outputFileName = inputFileName.replace('.csv', '') + '_result.txt'
    words, formulas = Reader(inputFileName)
    print(f'–ú–∞–∫—Å–∏–º—É–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: {Checker(words, formulas):,}')
    try:
        howMany = int(input('–°–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Å–¥–µ–ª–∞—Ç—å? '))
        #howMany = 24000
    except ValueError:
        sys.exit('–≠—Ç–æ –Ω–µ —á–∏—Å–ª–æ')
    i = 0
    errorCount = 0
    f = open(outputFileName, 'w')
    morph = pymorphy2.MorphAnalyzer()
    while i < howMany:
        phrase = Generator(words, formulas)
        phrase = Inflector(phrase, morph)
        if phrase:
            phrase = formatPhrase(phrase)
            f.write(phrase + '\n')
            i += 1
        else:
            errorCount += 1
    f.close()
    print(f'Done: {howMany}. Errors: {errorCount}')



def Reader(file_name):

    # READING
    
    csvData = read_csv(file_name, keep_default_na=False)
    final_list = []
    formulas = []
    for colNum, colName in enumerate(csvData):
        if colNum == 0:
            for formula in csvData[colName].tolist():  # formulas (column A)
                formulas.append(formula)
        elif not 'Unnamed' in colName:  # –µ—Å–ª–∏ —Å—Ç–æ–ª–±–µ—Ü —Å–æ —Å–ª–æ–≤–∞–º–∏ (–≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ id)
            final_list.append([])
            for word in csvData[colName].tolist():
                final_list[-1].append({})
                final_list[-1][-1]['word'] = word

                try:
                    id, parent_id = colName.split(':')
                except ValueError:
                    id = colName
                    parent_id = None    # —Ç—É—Ç –∏–∑–º–µ–Ω–∏–ª '' –Ω–∞ None 
                final_list[-1][-1]['id'], final_list[-1][-1]['parent_id'] = id, parent_id
        else:   # –µ—Å–ª–∏ —Å—Ç–æ–ª–±–µ—Ü —Ç–∞–±–ª–∏—Ü—ã —Å –¥–æ–ø –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π (–Ω–∞–∑–≤–∞–Ω–∏–µ –ø—É—Å—Ç–æ–µ)
            for row, effect in enumerate(csvData[colName].tolist()):
                final_list[-1][row]['effect'] = effect


    # CLEANING

    removeList = []
    for formula in formulas:
        if formula == '':
            removeList.append(formula)
    for formula in removeList:
        formulas.remove(formula)

    removeList = []
    for n, list in enumerate(final_list):
        for word in list:
            if word['word'] == '':
                removeList.append({})
                removeList[-1]['n'], removeList[-1]['item'] = n, word
    for list in removeList:
        final_list[list['n']].remove(list['item'])

    for n, formula in enumerate(formulas):
        formulas[n] = formula.replace(' ', '').split('+')

    return final_list, formulas

def Generator(listOfListsOfWords, formulas):
    try:
        phrase = []
        formula = random.choice(formulas)
        for letter in formula:
            for list in listOfListsOfWords:
                if list[0]['id'] == letter:
                    workingList = listOfListsOfWords.index(list)
                    break
            phrase.append(random.choice(listOfListsOfWords[workingList]))
        return phrase 
    except UnboundLocalError:
        sys.exit('–ù–µ –Ω–∞–π–¥–µ–Ω –ª–∏—Å—Ç –ø–æ–¥ –±—É–∫–≤–æ–π ' + letter)

def Inflector(phrase, morph):


    try:
        rightPhrase = ''
        for word in phrase:
            if word['parent_id'] != None and word['word'].count('$') == 0:
                inflectEffects = set()
                for donorWord in phrase:
                    if donorWord['id'] in word['parent_id']:
                        try:
                            donorWord['effect'] = donorWord['effect'].strip()
                            for effect in donorWord['effect'].split(' '):
                                inflectEffects.add(effect)
                        except KeyError:
                            print(f'Missing effect on parent-word: {donorWord}, \n for word: {word}.')
                            sys.exit()


                wordToInflect = word['word']
                if inflectEffects == {''}:
                    pass
                elif '%' in word['word']:
                    rIndex = 0
                    replaces = []
                    while True:
                        try:
                            lIndex = word['word'].index('%', rIndex)
                            rIndex = word['word'].index('%', lIndex+1)
                            wordToInflect = word['word'][lIndex+1:rIndex]
                            inflectResult = morph.parse(wordToInflect)[morphParsePosition(wordToInflect, morph)]
                            for effect in inflectEffects:
                                if effect == '':
                                    pass
                                else:
                                    iterationEffect = set()
                                    iterationEffect.add(effect)
                                    inflectResult = inflectResult.inflect(iterationEffect)
                            replaces.append({})
                            replaces[-1]['old'] = wordToInflect
                            replaces[-1]['new'] = inflectResult.word
                            rIndex += 1
                        except ValueError:
                            for replaceNum, replace in enumerate(replaces):
                                word['word'] = word['word'].replace(replaces[replaceNum]['old'], replaces[replaceNum]['new'])
                            break
                else:
                    inflectResult = morph.parse(wordToInflect)[morphParsePosition(wordToInflect, morph)]
                    for effect in inflectEffects:
                        if effect == '':
                            pass
                        else:
                            iterationEffect = set()
                            iterationEffect.add(effect)
                            try:
                                inflectResult = inflectResult.inflect(iterationEffect)
                            except ValueError:
                                print(f'Unknown Grammeme, word: {wordToInflect}, effect: {iterationEffect}, \n parsed form: {inflectResult}')
                    word['word'] = inflectResult.word
            if rightPhrase != '':
                rightPhrase += ' '
            rightPhrase += word['word']
        return rightPhrase
    except (AttributeError, TypeError) as e:
        with open('notInflected.txt', 'a') as f:
            f.write(str(phrase) + '\n')
            f.write(str(e) + '\n')
            f.write(word['word'] + '\n')
            f.write('\n')


def formatPhrase(string):
    string = re.sub(' +', ' ', string)
    string = string.replace(' ?', '?')
    string = string.replace(' !', '!')
    string = string.replace(' .', '.')
    string = string.replace(' :', ':')
    string = string.replace(' ,', ',')
    string = string.replace('%', '')
    string = string.replace('$', '')
    string = string.strip()
    string = string.replace('  ', ' ')
    string = string.capitalize()
    startOfSentence = string.find('.', 0, -2) + 2
    if startOfSentence != 1:
        string = string[0:startOfSentence] + string[startOfSentence].upper() + string[startOfSentence+1:]
    startOfSentence = string.find('!', 0, -2) + 2
    if startOfSentence != 1:
        string = string[0:startOfSentence] + string[startOfSentence].upper() + string[startOfSentence+1:]
    startOfSentence = string.find('üòä', 0, -2) + 2
    if startOfSentence != 1:
        string = string[0:startOfSentence] + string[startOfSentence].upper() + string[startOfSentence+1:]
    startOfSentence = string.find('?', 0, -2) + 2
    if startOfSentence != 1:
        string = string[0:startOfSentence] + string[startOfSentence].upper() + string[startOfSentence+1:]
    startOfSentence = string.find('?)', 0, -2) + 3
    if startOfSentence != 2:
        string = string[0:startOfSentence] + string[startOfSentence].upper() + string[startOfSentence+1:]
    return string
    

def Checker(listOfListsOfWords, formulas):

    final_sum = 0

    for formula in formulas:
        sum = 1
        for letter in formula:
            for list in listOfListsOfWords:
                if list[0]['id'] == letter:
                    workingList = listOfListsOfWords.index(list)
                    break
            sum = sum * len(listOfListsOfWords[workingList])
        final_sum += sum
    
    return final_sum

def morphParsePosition(word, morph):

    special_dictionary = {
        '–π–æ–≥–∞':1,
        '–π–æ–≥':1,
        '–≤—Å—ë':1,
        '—Ç–æ':3
    }


    position = 0
    try:
        if word in special_dictionary:
            position = special_dictionary[word]
            morph.parse(word)[position]
            return position
        else:
            for key in special_dictionary:
                if key in word:
                    position = special_dictionary[key]
                    morph.parse(word)[position]
                    return position
            
            return position
    except IndexError:
        return 0

main()